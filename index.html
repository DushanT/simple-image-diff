<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
</head>

<body>
  <h1>Upload files</h1>
  <h2>First image</h2>
  <div>
    <canvas id="firstCanvas"></canvas>
    <input id="file1" type="file" />
  </div>
  <h2>Second image</h2>
  <div>
    <canvas id="secondCanvas"></canvas>
    <input id="file2" type="file" />
  </div>
  <h2>Result</h2>
  <div>
    <canvas id="resultCanvas"></canvas>
  </div>
  <div>
    <button id="copyresult">Download result</button>
  </div>
  <script>
    firstCanvas.style.boxShadow = '0px 0px 5px 0px #ccc';
    firstCanvas.style.background = 'black';
    const firstCtx = firstCanvas.getContext("2d");
    
    secondCanvas.style.boxShadow = '0px 0px 5px 0px #ccc';
    secondCanvas.style.background = 'black';
    const secondCtx = secondCanvas.getContext("2d");

    resultCanvas.style.boxShadow = '0px 0px 5px 0px #ccc';
    const resultCtx = resultCanvas.getContext("2d");

    const image = document.createElement('img');
    const image2 = document.createElement('img');

    const handleChange = (image) => async (e) => {
      const [file] = e.target.files;
      if (file) {
        var fr = new FileReader();
        fr.onload = function () {
          image.src = fr.result;
        }
        fr.readAsDataURL(file);
      }
    };

    file1.addEventListener('change', handleChange(image));
    file2.addEventListener('change', handleChange(image2));

    const handleCopy = () => {
      const image = resultCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");  // here is the most important part because if you dont replace you will get a DOM 18 exception.

      window.location.href = image; // it will save locally
    }
    copyresult.addEventListener('click', handleCopy);

    const draw = () => {
      firstCanvas.width = Math.max(image.width, image2.width);
      firstCanvas.height = image.height;
      firstCtx.clearRect(0, 0, firstCanvas.width, firstCanvas.height);
      firstCtx.drawImage(image, 0, 0);
      
      secondCanvas.width = firstCanvas.width;
      secondCanvas.height = firstCanvas.height;
      secondCtx.clearRect(0, 0, firstCanvas.width, firstCanvas.height);
      secondCtx.drawImage(image2, 0, 0);

      const imageData = firstCtx.getImageData(0, 0, image.width, image.height);
      const imageData2 = secondCtx.getImageData(0, 0, image.width, image.height)
      
      const newImageData = compareImages(imageData, imageData2);
      resultCanvas.width = Math.max(image.width, image2.width);
      resultCanvas.height = image.height;

      resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
      resultCtx.putImageData(newImageData, 0, 0);
    };

    image.onload = draw;
    image2.onload = draw;


    function compareImages(firstData, secondData) {
      const { data } = firstData;
      const { data: data2 } = secondData;
      for (let i = 0; i < data.length; i += 4) {
        const [r, g, b, a] = data.slice(i, i + 4);
        const [r2, g2, b2, a2] = data2.slice(i, i + 4);
        if (!isSimilar([r, g, b, a], [r2, g2, b2, a2], 10)) {
          firstData.data[i] = 255;
          firstData.data[i + 1] = 0;
          firstData.data[i + 2] = 0;
          firstData.data[i + 3] = 255;
        }
      }
      return firstData;
    }

    function isSimilar(firstArray, secondArray, treshold) {
      if (firstArray.some((p, index) => Math.abs(p - secondArray[index]) > treshold)) {
        return false
      }
      return true;
    }

    document.body.appendChild(canvas);

  </script>
</body>

</html>